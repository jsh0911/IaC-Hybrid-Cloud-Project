- name: Install Jenkins via SSM Run Command (AWS CLI)
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Find instance by Name tag
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ jenkins_instance_name_tag }}"
          "instance-state-name": "running"
      register: ec2

    - name: Fail if instance not found
      ansible.builtin.fail:
        msg: "No running instance found with tag Name={{ jenkins_instance_name_tag }}"
      when: ec2.instances | length == 0

    - name: Set instance id
      ansible.builtin.set_fact:
        instance_id: "{{ ec2.instances[0].instance_id }}"

    - name: Build SSM commands (Amazon Linux)
      ansible.builtin.set_fact:
        ssm_commands:
          - "set -e"
          - "source /etc/os-release || true"
          - "echo OS=$ID VERSION=$VERSION_ID"
          - "sudo yum -y update || true"
          - "sudo yum -y install java-17-amazon-corretto-headless wget || sudo yum -y install java-17-amazon-corretto wget"
          - "sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo"
          - "sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key"
          - "sudo yum -y install jenkins"
          - "sudo systemctl enable --now jenkins"
          - "sudo sed -i \"s|^JENKINS_LISTEN_ADDRESS=.*|JENKINS_LISTEN_ADDRESS={{ jenkins_bind_host }}|\" /etc/sysconfig/jenkins || true"
          - "sudo systemctl restart jenkins"
          - "sudo systemctl status jenkins --no-pager || true"
          - "echo '--- initialAdminPassword ---'"
          - "sudo cat /var/lib/jenkins/secrets/initialAdminPassword || true"

    - name: Send SSM RunShellScript
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - send-command
          - --region
          - "{{ aws_region }}"
          - --instance-ids
          - "{{ instance_id }}"
          - --document-name
          - AWS-RunShellScript
          - --parameters
          - "{{ {'commands': ssm_commands} | to_json }}"
          - --query
          - Command.CommandId
          - --output
          - text
      register: cmd_id
      changed_when: true

    - name: Wait command completion
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - get-command-invocation
          - --region
          - "{{ aws_region }}"
          - --command-id
          - "{{ cmd_id.stdout }}"
          - --instance-id
          - "{{ instance_id }}"
          - --query
          - Status
          - --output
          - text
      register: cmd_status
      changed_when: false
      retries: 30
      delay: 10
      until: cmd_status.stdout in ['Success','Failed','TimedOut','Cancelled']

    - name: Get STDOUT
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - get-command-invocation
          - --region
          - "{{ aws_region }}"
          - --command-id
          - "{{ cmd_id.stdout }}"
          - --instance-id
          - "{{ instance_id }}"
          - --query
          - StandardOutputContent
          - --output
          - text
      register: cmd_stdout
      changed_when: false

    - name: Get STDERR
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - get-command-invocation
          - --region
          - "{{ aws_region }}"
          - --command-id
          - "{{ cmd_id.stdout }}"
          - --instance-id
          - "{{ instance_id }}"
          - --query
          - StandardErrorContent
          - --output
          - text
      register: cmd_stderr
      changed_when: false

    - name: Show results
      ansible.builtin.debug:
        msg:
          - "InstanceId={{ instance_id }}"
          - "CommandId={{ cmd_id.stdout }}"
          - "Status={{ cmd_status.stdout }}"
          - "STDOUT:\n{{ cmd_stdout.stdout }}"
          - "STDERR:\n{{ cmd_stderr.stdout }}"
