- name: Fix Jenkins startup (timeout/swap/java opts) via SSM
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Find instance by Name tag
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ jenkins_instance_name_tag }}"
          "instance-state-name": "running"
      register: ec2

    - name: Fail if instance not found
      ansible.builtin.fail:
        msg: "No running instance found with tag Name={{ jenkins_instance_name_tag }}"
      when: ec2.instances | length == 0

    - name: Set instance id
      ansible.builtin.set_fact:
        instance_id: "{{ ec2.instances[0].instance_id }}"

    - name: Build fix commands
      ansible.builtin.set_fact:
        ssm_commands:
          - "set -e"
          - "echo '=== Add swap if not exists ==='"
          - |
            if ! sudo swapon --show | grep -q /swapfile; then
              sudo fallocate -l 2G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              grep -q '^/swapfile' /etc/fstab || echo '/swapfile swap swap defaults 0 0' | sudo tee -a /etc/fstab >/dev/null
            fi
          - "sudo swapon --show || true"
          - "echo '=== Set Jenkins Java heap (safe for small instances) ==='"
          - |
            sudo grep -q '^JENKINS_JAVA_OPTIONS=' /etc/sysconfig/jenkins \
              && sudo sed -i 's|^JENKINS_JAVA_OPTIONS=.*|JENKINS_JAVA_OPTIONS=\"-Djava.awt.headless=true -Xms256m -Xmx768m\"|' /etc/sysconfig/jenkins \
              || echo 'JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Xms256m -Xmx768m"' | sudo tee -a /etc/sysconfig/jenkins >/dev/null
          - "echo '=== Bind address (SSM port forward recommended) ==='"
          - |
            sudo grep -q '^JENKINS_LISTEN_ADDRESS=' /etc/sysconfig/jenkins \
              && sudo sed -i 's|^JENKINS_LISTEN_ADDRESS=.*|JENKINS_LISTEN_ADDRESS={{ jenkins_bind_host }}|' /etc/sysconfig/jenkins \
              || echo 'JENKINS_LISTEN_ADDRESS={{ jenkins_bind_host }}' | sudo tee -a /etc/sysconfig/jenkins >/dev/null
          - "echo '=== Increase systemd timeout for Jenkins ==='"
          - "sudo mkdir -p /etc/systemd/system/jenkins.service.d"
          - |
            cat <<'EOT' | sudo tee /etc/systemd/system/jenkins.service.d/override.conf >/dev/null
            [Service]
            TimeoutStartSec=600
            EOT
          - "sudo systemctl daemon-reload"
          - "echo '=== Restart Jenkins ==='"
          - "sudo systemctl restart jenkins"
          - "sudo systemctl status jenkins --no-pager -l || true"
          - "echo '--- initialAdminPassword ---'"
          - "sudo cat /var/lib/jenkins/secrets/initialAdminPassword || true"
          - "echo '=== Ports ==='"
          - "sudo ss -lntp | grep ':8080' || true"

    - name: Send SSM fix command
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - send-command
          - --region
          - "{{ aws_region }}"
          - --instance-ids
          - "{{ instance_id }}"
          - --document-name
          - AWS-RunShellScript
          - --parameters
          - "{{ {'commands': ssm_commands} | to_json }}"
          - --query
          - Command.CommandId
          - --output
          - text
      register: cmd_id
      changed_when: true

    - name: Wait command completion (up to 20 minutes)
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - get-command-invocation
          - --region
          - "{{ aws_region }}"
          - --command-id
          - "{{ cmd_id.stdout }}"
          - --instance-id
          - "{{ instance_id }}"
          - --query
          - Status
          - --output
          - text
      register: cmd_status
      changed_when: false
      retries: 120
      delay: 10
      until: cmd_status.stdout in ['Success','Failed','TimedOut','Cancelled']

    - name: Get STDOUT
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - get-command-invocation
          - --region
          - "{{ aws_region }}"
          - --command-id
          - "{{ cmd_id.stdout }}"
          - --instance-id
          - "{{ instance_id }}"
          - --query
          - StandardOutputContent
          - --output
          - text
      register: cmd_stdout
      changed_when: false

    - name: Get STDERR
      ansible.builtin.command:
        argv:
          - aws
          - ssm
          - get-command-invocation
          - --region
          - "{{ aws_region }}"
          - --command-id
          - "{{ cmd_id.stdout }}"
          - --instance-id
          - "{{ instance_id }}"
          - --query
          - StandardErrorContent
          - --output
          - text
      register: cmd_stderr
      changed_when: false

    - name: Fail if not success
      ansible.builtin.fail:
        msg:
          - "Jenkins fix command did not succeed. Status={{ cmd_status.stdout }}"
          - "STDERR:\n{{ cmd_stderr.stdout }}"
      when: cmd_status.stdout != 'Success'

    - name: Print result
      ansible.builtin.debug:
        msg:
          - "InstanceId={{ instance_id }}"
          - "CommandId={{ cmd_id.stdout }}"
          - "Status={{ cmd_status.stdout }}"
          - "STDOUT:\n{{ cmd_stdout.stdout }}"
