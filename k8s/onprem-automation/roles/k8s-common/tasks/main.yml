---
- name: Set hostname to inventory name
  become: true
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Build /etc/hosts entries for all nodes
  ansible.builtin.set_fact:
    k8s_hosts_block: |
      {% for h in (groups['k8s_master'] | default([])) + (groups['k8s_workers'] | default([])) + (groups['db'] | default([])) %}
      {{ hostvars[h].ansible_host | default(h) }} {{ h }}
      {% endfor %}

- name: Ensure /etc/hosts contains cluster hostnames
  become: true
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE K8S HOSTS"
    block: "{{ k8s_hosts_block }}"

- name: Install base packages
  become: true
  ansible.builtin.apt:
    update_cache: true
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - lsb-release
      - gnupg
      - software-properties-common
      - socat
      - conntrack
      - ipset
      - ebtables
      - ethtool
      - jq
    state: present

- name: Disable swap immediately
  become: true
  ansible.builtin.command: swapoff -a
  changed_when: false

- name: Disable swap permanently in /etc/fstab
  become: true
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^(\s*[^#]\S+\s+\S+\s+swap\s+\S+.*)$'
    replace: '# \1'

- name: Ensure kernel modules are loaded
  become: true
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
    owner: root
    group: root
    mode: "0644"

- name: Load kernel modules now
  become: true
  ansible.builtin.shell: |
    modprobe overlay
    modprobe br_netfilter
  args:
    executable: /bin/bash
  changed_when: false

- name: Set sysctl params for Kubernetes networking
  become: true
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1
    owner: root
    group: root
    mode: "0644"

- name: Apply sysctl
  become: true
  ansible.builtin.command: sysctl --system
  changed_when: false
